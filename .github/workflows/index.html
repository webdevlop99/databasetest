<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vessel Compliance - Supabase</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-4xl mx-auto bg-white shadow p-6 rounded-xl">

<h1 class="text-2xl font-bold mb-4">Vessel Compliance Manager (Supabase)</h1>

<!-- Vessel Form -->
<div class="mb-6">
  <h2 class="text-xl font-semibold mb-2">Add Vessel</h2>
  <input id="vesselName" placeholder="Vessel Name" class="w-full p-2 border rounded" />
  <button onclick="saveVessel()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded">Save Vessel</button>
</div>

<!-- Certificates Form -->
<div>
  <h2 class="text-xl font-semibold">Add Certificates</h2>

  <select id="vesselSelect" class="mt-2 w-full p-2 border rounded"></select>

  <select id="certType" class="mt-2 w-full p-2 border rounded">
    <option value="SMC">SMC</option>
    <option value="ISPS">ISPS</option>
    <option value="MLC">MLC</option>
  </select>

  <input type="date" id="issueDate" class="mt-2 p-2 border rounded w-full" />
  <input type="date" id="expiryDate" class="mt-2 p-2 border rounded w-full" />

  <label class="mt-2 block">
    <input type="checkbox" id="intermediateCompleted" /> Intermediate Completed
  </label>

  <button onclick="saveCertificate()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded">Save Certificate</button>
</div>

<hr class="my-6">

<!-- Vessel List -->
<h2 class="text-xl font-semibold mb-2">Vessels</h2>
<div id="vesselList"></div>

</div>

<script>
const supabase = supabase.createClient(
  "https://scrrfncbapoauwlnxjsp.supabase.co",
  "sb_publishable_D1PsT8_81tyO_HeheM-UdQ_t66vH-2m"
);

// Load vessels
async function loadVessels() {
  let { data } = await supabase.from("vessels").select("*").order("vessel_name");
  let list = document.getElementById("vesselList");
  let select = document.getElementById("vesselSelect");
  list.innerHTML = "";
  select.innerHTML = "";

  data.forEach(v => {
    select.innerHTML += `<option value="${v.id}">${v.vessel_name}</option>`;
    list.innerHTML += `
      <div class="p-3 border rounded mt-2 bg-gray-50">
        <b>${v.vessel_name}</b>
        <button onclick="deleteVessel('${v.id}')" class="float-right text-red-600">Delete</button>
      </div>
    `;
  });
}

// Save Vessel
async function saveVessel() {
  const name = document.getElementById("vesselName").value.trim();
  if (!name) return alert("Enter vessel name");

  await supabase.from("vessels").insert([{ vessel_name: name }]);
  document.getElementById("vesselName").value = "";
  loadVessels();
}

// Delete Vessel
async function deleteVessel(id) {
  await supabase.from("vessels").delete().eq("id", id);
  loadVessels();
}

// Auto-calc intermediate date (midpoint)
function calcIntermediate(issue, expiry) {
  let issueD = new Date(issue);
  let expiryD = new Date(expiry);

  let midpoint = new Date((issueD.getTime() + expiryD.getTime()) / 2);
  return midpoint.toISOString().split("T")[0];
}

// Save Certificate
async function saveCertificate() {
  let vessel = document.getElementById("vesselSelect").value;
  let type = document.getElementById("certType").value;
  let issue = document.getElementById("issueDate").value;
  let expiry = document.getElementById("expiryDate").value;
  let completed = document.getElementById("intermediateCompleted").checked;

  if (!issue || !expiry) return alert("Enter both dates");

  let intermediate = calcIntermediate(issue, expiry);

  await supabase.from("certificates").insert([
    {
      vessel_id: vessel,
      cert_type: type,
      issue_date: issue,
      expiry_date: expiry,
      intermediate_date: intermediate,
      intermediate_completed: completed
    }
  ]);

  alert("Certificate saved!");
}

loadVessels();
</script>
</body>
</html>
